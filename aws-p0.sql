SET AUTOCOMMIT ON
--ROLLBACK;

--TABLE CREATIONS
CREATE TABLE USER_ACCOUNTS
(
    USER_ID         NUMBER                  NOT NULL,
    USER_NAME       VARCHAR2(32)            NOT NULL UNIQUE,
    HASHPASS        VARCHAR2(64)            NOT NULL ,   --NOT STERILIZED, IS A HASH. BE CAREFUL.
    CONSTRAINT      PK_USERS                PRIMARY KEY (USER_ID)
);

CREATE TABLE MONEY_ACCOUNTS
(
    ACCT_NUMBER     NUMBER                  NOT NULL,
    ACCT_TYPE       VARCHAR(16)             NOT NULL,
    WORTH           NUMBER                  NOT NULL,
    CONSTRAINT      PK_MONEY_ACCOUNTS       PRIMARY KEY (ACCT_NUMBER)
);

CREATE TABLE ACCOUNT_LINKAGES
(
    USER_ID         NUMBER                  NOT NULL,
    ACCT_NUMBER     NUMBER                  NOT NULL,
    LINKAGE_ID      NUMBER                  NOT NULL,
    CONSTRAINT      PK_ACCOUNT_LINKAGES     PRIMARY KEY (LINKAGE_ID)
);

--NON FK CONSTRAINTS
ALTER TABLE MONEY_ACCOUNTS
    ADD CHECK(WORTH >= 0);

--FOREIGN KEYS
ALTER TABLE ACCOUNT_LINKAGES
    ADD CONSTRAINT FK_USERID_USER_ACCTLINKS
    FOREIGN KEY (USER_ID) REFERENCES USER_ACCOUNTS(USER_ID);
    
ALTER TABLE ACCOUNT_LINKAGES
    ADD CONSTRAINT FK_ACCTNUM_MACCTS_ACCTLINKS
    FOREIGN KEY (ACCT_NUMBER) REFERENCES MONEY_ACCOUNTS(ACCT_NUMBER);
    
--AUTO ITERATING ID RULES
CREATE SEQUENCE UID_SEQ;
CREATE SEQUENCE LINKAGE_SEQ;

CREATE OR REPLACE TRIGGER USER_ON_INSERT
BEFORE INSERT ON USER_ACCOUNTS
FOR EACH ROW
BEGIN
    SELECT UID_SEQ.NEXTVAL
    INTO :NEW.USER_ID
    FROM DUAL;
END;
/

CREATE OR REPLACE TRIGGER LINKAGE_ON_INSERT
BEFORE INSERT ON ACCOUNT_LINKAGES
FOR EACH ROW
BEGIN
    SELECT LINKAGE_SEQ.NEXTVAL
    INTO :NEW.LINKAGE_ID
    FROM DUAL;
END;
/

CREATE OR REPLACE PROCEDURE GET_WORTH(MID IN NUMBER, WRTH OUT NUMBER)
IS
BEGIN
    SELECT MONEY_ACCOUNTS.WORTH
    INTO WRTH
    FROM MONEY_ACCOUNTS
    WHERE ACCT_NUMBER = MID;
END;
/

/*
THE RESET TOOLS SO I DON'T NEED TO RETYPE THEM

DROP PROCEDURE GET_WORTH;
DROP TABLE ACCOUNT_LINKAGES;
DROP TABLE MONEY_ACCOUNTS;
DROP TABLE USER_ACCOUNTS;
DROP SEQUENCE LINKAGE_SEQ;
DROP SEQUENCE UID_SEQ;
DROP TRIGGER LINKAGE_ON_INSERT;
DROP TRIGGER USER_ON_INSERT;
*/

--ADDING SOME STUFF
--USERS
INSERT INTO USER_ACCOUNTS (USER_ID, USER_NAME, HASHPASS) VALUES(1, 'testguy', STANDARD_HASH('password_01', 'SHA256'));
INSERT INTO USER_ACCOUNTS (USER_ID, USER_NAME, HASHPASS) VALUES(2, 'anothertestguy', STANDARD_HASH('password_02', 'SHA256'));
INSERT INTO USER_ACCOUNTS (USER_ID, USER_NAME, HASHPASS) VALUES(3, 'notreal', STANDARD_HASH('password_03', 'SHA256'));
INSERT INTO USER_ACCOUNTS (USER_ID, USER_NAME, HASHPASS) VALUES(4, 'someguy', STANDARD_HASH('password_04', 'SHA256'));
INSERT INTO USER_ACCOUNTS (USER_ID, USER_NAME, HASHPASS) VALUES(5, 'anotheruser', STANDARD_HASH('password_05', 'SHA256'));
INSERT INTO USER_ACCOUNTS (USER_ID, USER_NAME, HASHPASS) VALUES(9001, 'hypotheticus', STANDARD_HASH('password_06', 'SHA256'));
INSERT INTO USER_ACCOUNTS (USER_ID, USER_NAME, HASHPASS) VALUES(7, 'allinyourhead', STANDARD_HASH('password_07', 'SHA256'));
--MONEY_ACCOUNTS
INSERT INTO MONEY_ACCOUNTS (ACCT_NUMBER, ACCT_TYPE, WORTH) VALUES(100000001, 'CHECKING', 4.00);
INSERT INTO MONEY_ACCOUNTS (ACCT_NUMBER, ACCT_TYPE, WORTH) VALUES(200000001, 'SAVINGS', 4000.00);
INSERT INTO MONEY_ACCOUNTS (ACCT_NUMBER, ACCT_TYPE, WORTH) VALUES(100000002, 'CHECKING', 52.00);
INSERT INTO MONEY_ACCOUNTS (ACCT_NUMBER, ACCT_TYPE, WORTH) VALUES(100000003, 'CHECKING', 74.00);
INSERT INTO MONEY_ACCOUNTS (ACCT_NUMBER, ACCT_TYPE, WORTH) VALUES(100000004, 'CHECKING', 32.00);
INSERT INTO MONEY_ACCOUNTS (ACCT_NUMBER, ACCT_TYPE, WORTH) VALUES(100000005, 'CHECKING', 127.00);
INSERT INTO MONEY_ACCOUNTS (ACCT_NUMBER, ACCT_TYPE, WORTH) VALUES(300000001, 'JOINT', 20000.00);
--ACCOUNT_LINKAGES
INSERT INTO ACCOUNT_LINKAGES (USER_ID, ACCT_NUMBER, LINKAGE_ID) VALUES(1, 100000001, 1);
INSERT INTO ACCOUNT_LINKAGES (USER_ID, ACCT_NUMBER, LINKAGE_ID) VALUES(1, 300000001, 2);
INSERT INTO ACCOUNT_LINKAGES (USER_ID, ACCT_NUMBER, LINKAGE_ID) VALUES(2, 100000002, 3);
INSERT INTO ACCOUNT_LINKAGES (USER_ID, ACCT_NUMBER, LINKAGE_ID) VALUES(2, 200000001, 4);
INSERT INTO ACCOUNT_LINKAGES (USER_ID, ACCT_NUMBER, LINKAGE_ID) VALUES(3, 300000001, 5);
INSERT INTO ACCOUNT_LINKAGES (USER_ID, ACCT_NUMBER, LINKAGE_ID) VALUES(4, 100000003, 6);
INSERT INTO ACCOUNT_LINKAGES (USER_ID, ACCT_NUMBER, LINKAGE_ID) VALUES(5, 100000004, 7);
INSERT INTO ACCOUNT_LINKAGES (USER_ID, ACCT_NUMBER, LINKAGE_ID) VALUES(6, 100000005, 8);
INSERT INTO ACCOUNT_LINKAGES (USER_ID, ACCT_NUMBER, LINKAGE_ID) VALUES(7, 300000001, 9);

COMMIT;